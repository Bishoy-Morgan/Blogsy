{% extends "base.html" %}
{% block title %}{{ profile_user.first_name }}'s Profile{% endblock %}

{% block content %}
<div class="w-100 h-100 d-flex align-items-start justify-content-between">

    <!-- LEFT CONTENT -->
    <div class="blog-list">

        <h2 class="user-profile-name mb-5 mt-3 fw-bold">
            {{ profile_user.first_name }}
        </h2>

        <div class="user-info">
            {% if profile_user.profile_image %}
                <img 
                    src="{{ url_for('static', filename='profile_images/' + profile_user.profile_image) }}"
                    alt="{{ profile_user.first_name }}'s Profile Image"
                    style="width: 150px; height: 150px; object-fit: cover;"
                    class="rounded-circle"
                    loading="lazy"
                />
            {% else %}
                <div class="letter-avatar mt-5 d-flex align-items-center justify-content-center rounded-circle">
                    {{ profile_user.first_name[0]|upper }}
                </div>
            {% endif %}

            <div class="d-flex flex-column align-items-start">
                <p class="mb-0 text-gray">
                    <strong id="followers-count">{{ profile_user.followers.count() }}</strong> Followers
                </p>
            </div>
        </div>

        <!-- TABS -->
        <ul class="user-profile-tabs d-flex gap-3 mb-4">
            <li class="nav-item">
                <button class="nav-link active" data-tab="blogs-tab">Blogs</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-tab="followers-tab">Followers</button>
            </li>
        </ul>

        <!-- BLOGS TAB -->
        <div id="blogs-tab" class="tab-section mt-5 active">
            {% if blogs %}
                {% for blog in blogs %}
                    <div class="post mb-5 pb-5">

                        <div class="post-content">
                            <div class="d-flex align-items-center mb-4">
                                {% if blog.author.profile_image %}
                                    <img 
                                        src="{{ url_for('static', filename='profile_images/' + blog.author.profile_image) }}" 
                                        class="author-profile-img"
                                        style="width: 2rem; height: 2rem; border-radius: 8px; object-fit: cover;"
                                        loading="lazy"
                                    />
                                {% else %}
                                    <button class="blog-author">
                                        {{ blog.author.first_name[0] if blog.author.first_name else '' }}
                                    </button>
                                {% endif %}

                                <small class="text-gray ms-2">by</small>
                                <small class="text-black mx-1">{{ blog.author.first_name }}</small>
                            </div>

                            <a href="{{ url_for('views.view_post', blog_id=blog.id) }}" class="text-decoration-none">
                                <h3 class="mb-4 mt-1 fw-bold">{{ blog.title }}</h3>

                                <p class="text-gray">
                                    {{ blog.content | striptags | truncate(250, True, '...') }}
                                </p>

                                <div class="d-flex align-items-center justify-content-between mt-4 pe-4">
                                    <div class="d-flex align-items-center gap-4 font-11">
                                        <small class="text-gray">
                                            {{ blog.date_created.strftime('%b %d, %Y') }}
                                        </small>

                                        <span>{{ blog.likes|length }} Likes</span>
                                        <span>{{ blog.comments|length }} Comments</span>
                                    </div>

                                    {% if current_user.is_authenticated %}
                                        {% set is_saved = blog.id in (current_user.reading_list | map(attribute='id') | list) %}
                                    {% else %}
                                        {% set is_saved = false %}
                                    {% endif %}

                                    <form method="POST"
                                          action="{{ url_for('views.toggle_reading_list', blog_id=blog.id) }}">
                                        <button type="submit" class="btn p-0 border-0 bg-transparent">
                                            <img 
                                                src="{{ url_for('static', filename='images/' ~ ('save-remove.svg' if is_saved else 'save.svg')) }}"
                                                style="width: 1.5rem;"
                                                loading="lazy"
                                            />
                                        </button>
                                    </form>
                                </div>
                            </a>
                        </div>

                        <div class="post-image mt-3">
                            <img 
                                src="{{ url_for('static', filename='uploads/' + blog.image_filename) }}"
                                class="blog-img"
                                style="width: 100%; border-radius: 8px; max-height: 150px; object-fit: cover;"
                                loading="lazy"
                            />
                        </div>

                    </div>
                {% endfor %}
            {% else %}
                <p>No blogs yet.</p>
            {% endif %}
        </div>

        <!-- FOLLOWERS TAB -->
        <div id="followers-tab" class="tab-section my-5 d-none">
            {% if profile_user.followers.count() > 0 %}
                {% for follower in profile_user.followers %}
                    <div class="followers-container d-flex justify-content-between align-items-center mb-3">

                        <div class="d-flex align-items-center gap-2">
                            {% if follower.profile_image %}
                                <img 
                                    src="{{ url_for('static', filename='profile_images/' + follower.profile_image) }}"
                                    class="author-profile-img rounded-circle"
                                    style="width: 3rem; height: 3rem;"
                                    loading="lazy"
                                />
                            {% else %}
                                <button class="blog-author rounded-circle" style="width: 3rem; height: 3rem;">
                                    {{ follower.first_name[0] }}
                                </button>
                            {% endif %}

                            <a href="{{ url_for('views.user_profile', username=follower.username) }}"
                               class="fw-bold text-decoration-none text-black">
                                {{ follower.first_name }}
                            </a>
                        </div>

                        {% if current_user.is_authenticated and follower.id != current_user.id %}
                            {% if current_user.is_following(follower) %}
                                <form method="POST" action="{{ url_for('views.unfollow', user_id=follower.id) }}">
                                    <button class="unfollow-btn">Unfollow</button>
                                </form>
                            {% else %}
                                <form method="POST" action="{{ url_for('views.follow', user_id=follower.id) }}">
                                    <button class="follow-btn">Follow</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>No followers yet.</p>
            {% endif %}
        </div>

    </div>

    <!-- RIGHT ASIDE -->
    <aside>

        <h4 class="poppins">{{ profile_user.first_name }}</h4>

        <p class="text-gray">
            <strong>{{ profile_user.followers.count() }}</strong> Followers
        </p>

        {% if current_user.is_authenticated and current_user.id != profile_user.id %}
            {% if current_user.is_following(profile_user) %}
                <form method="POST" action="{{ url_for('views.unfollow', user_id=profile_user.id) }}">
                    <button class="unfollow-btn">Unfollow</button>
                </form>
            {% else %}
                <form method="POST" action="{{ url_for('views.follow', user_id=profile_user.id) }}">
                    <button class="follow-btn">Follow</button>
                </form>
            {% endif %}
        {% endif %}

    </aside>
</div>
{% endblock %}